<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/custom.css">
    
    <title>Registro de usuarios</title>
  </head>
    

  <body>

    <header id="header" class="header">
        <div class="container">
            <div class="row">

                <div class="two columns">
                    <img src="img/logo.png" alt="" id="logo">
                </div>

                <div class="two columns u-pull-right">
                    <ul>
                        <li class="submenu">
                            <img src="img/cart.png" alt="" id="img-carrito">
                            <div id="carrito">
                                <table id="lista-carrito" class="u-full-width">
                                    <thead>
                                        <tr>
                                            <th>Imagen</th>
                                            <th>Nombre</th>
                                            <th>Precio</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <a href="#" id="vaciar-carrito" class="button u-full-width">Vaciar carrito</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="row">
                    <div class="eight columns">
                        <ul class="navct">
                            <li class="two columns"><a href="index.html">Inicio</a></li>
                            <li class="two columns"><a href="sobre.html">Nosotros</a></li>
                            <li class="three columns"><a href="contacto.html">Donaciones</a></li>
                            <li class="two columns"><a href="login.html">Login</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </header>
    <div>
    <h1>Registra tus datos</h1>
    </div>

    <!-- Formulario-->
    <form>
        <div class="form-group col-md-2">
        </div> 
        
        <div class="form-group col-md-10">
            <!--RUT-->
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="inputRut">Rut</label>
                    <input type="text" class="form-control" id="inputRut" placeholder="">
                </div>
                <div class="form-group col-md-1">
                    <label for="inputDv">Dv</label>
                    <input type="text" class="form-control" id="inputDv" placeholder="">
                </div>
            </div>
            <!--Nombres-->
            <div class="form-row">
                <div class="form-group col-md-6">
                <label for="inputPrimerNombre">Primer Nombre</label>
                <input type="text" class="form-control" id="inputPrimerNombre" placeholder="">
                </div>
                <div class="form-group col-md-6">
                <label for="inputSegundoNombre">Segundo Nombre</label>
                <input type="text" class="form-control" id="inputSegundoNombre" placeholder="">
                </div>
            </div>
            <!--Apellidos-->
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="inputApellidoPaterno">Apellido paterno</label>
                    <input type="text" class="form-control" id="inputSegundoNombre" placeholder="">
                </div>
                <div class="form-group col-md-6">
                    <label for="inputApellidoMaterno">Apellido materno</label>
                    <input type="text" class="form-control" id="inputSegundoApellido" placeholder="">
                </div>
            </div>
            <!--Dirección-->
            <div class="form-row">
            <div class="form-group col-md-4">
                <label for="inputDireccion">Dirección</label>
                <input type="text" class="form-control" id="inputDireccion">
            </div>
            <div class="form-group col-md-4">
                <label for="inputRegion">Región</label>
                <select id="inputRegion" class="form-control">
                <option selected>Región</option>
                <option>...</option>
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="inputComuna">Comuna</label>
                <input type="text" id="inputComuna" class="form-control">
            </div>
            <!--Telefono-->
            <div class="form-group col-md-4">
                <label for="inputFono">Teléfono</label>
                <input type="text" class="form-control" id="inputTelefono">
            </div>
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="gridCheck">
                    <label class="form-check-label" for="gridCheck">
                    ¿Desea suscribirse para hacer donaciónes a la fundación? 
                    </label>
                </div>
            </div>
            <!--Botones-->
            <div class="form-group row mb-0 pt-2 ">
                <div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
                <div class="col-2 col-sm-2 d-flex justify-content-start">
                    <button id="btn_limpiar" class="btn btn-success">Limpiar</button>
                </div>
            </div>
        </div>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
    
    <script> 

        const API_URL = 'https://5000-ernestoleonida-flaskapi-a1pyakms39h.ws-us47.gitpod.io';
    
        //cargar tabla con usuarios cargados desde ajax
        $(document).ready(function(){
          $('#tablaUsuarios tbody').empty();
          
          $('#btnEditarUsuarioTabla').hide();
          $('#btnCancelarEdicion').hide();
          actualizarTabla()
        });
    
          //click en .btnEditarusuario
          $(document).on('click', '.btnEditarusuario', function(){
            //obtener el id del usuario
            var idUsuario = $(this).closest('tr').find('th').text();
            //obtener todo el usuario
            var usuario = $(this).closest('tr').find('td');
            //obtener los datos del usuario
            var primer_nombre = usuario.eq(0).text();
            var segundo_nombre = usuario.eq(1).text();
            var apellido_paterno = usuario.eq(2).text();
            var apellido_materno = usuario.eq(3).text();
            var direccion = usuario.eq(4).text();
    
            //mostrar los datos del usuario en los inputs
            $('#inputPrimerNombre').val(primer_nombre);
            $('#inputSegundoNombre').val(segundo_nombre);
            $('#inputApellidoPaterno').val(apellido_paterno);
            $('#inputApellidoMaterno').val(apellido_materno);
            $('#inputDireccion').val(direccion);
            $('#inputIdUsuario').val(idUsuario);
    
            $('#btnAgregarUsuario').hide();
            $('#btnEditarUsuarioTabla').show();
            $('#btnCancelarEdicion').show();
          });
    
    
          //añadir usuario a la lista con jquery
          $(document).on('click', '#btnAgregarUsuario', function(){
            //obtener los datos del usuario
            var primer_nombre = $('#inputPrimerNombre').val();
            var segundo_nombre = $('#inputSegundoNombre').val();
            var apellido_paterno = $('#inputApellidoPaterno').val();
            var apellido_materno = $('#inputApellidoMaterno').val();
            var direccion = $('#inputDireccion').val();
    
            //cargar a la db mediante ajax mi usuario
            $.ajax({
                url: API_URL+'/usuarios',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    primer_nombre: primer_nombre,
                    segundo_nombre: segundo_nombre,
                    apellido_paterno: apellido_paterno,
                    apellido_materno: apellido_materno,
                    direccion: direccion
                }),
                success: function(respuesta){
                    console.log(respuesta);
                    actualizarTabla();
                }
            })
    
          });
          
    
          //borrar usuario de la lista con jquery
          $(document).on('click', '.btnEliminarUsuario', function(){
            //eliminar la fila
            var idUsuario = $(this).closest('tr').find('th').text();
    
            $.ajax({
                url: API_URL+'/usuarios/'+idUsuario,
                type: 'DELETE',
                dataType: 'json',
                data: {
                    id:idUsuario
                },
                success: function(respuesta){
                    console.log('Usuario Eliminado')
                    actualizarTabla()
                }
    
            })
    
    
    
          });
    
          //funcion encontrar el ultimo id de la tabla
          function obtenerUltimoId(){
            var ultimoId = $('#tablaUsuarios tr:last th').text();
            return parseInt(ultimoId) + 1;
          }
    
          //editar usuario con ajax
          $(document).on('click', '#btnEditarUsuarioTabla', function(){
            //obtener los datos del usuario
            var primer_nombre = $('#inputPrimerNombre').val();
            var segundo_nombre = $('#inputSegundoNombre').val();
            var apellido_paterno = $('#inputApellidoPaterno').val();
            var apellido_materno = $('#inputApellidoMaterno').val();
            var direccion = $('#inputDireccion').val();
            var idUsuario = $('#inputIdUsuario').val();
    
            $.ajax({
                url: API_URL+'/usuarios/'+idUsuario,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    primer_nombre: primer_nombre,
                    segundo_nombre: segundo_nombre,
                    apellido_paterno: apellido_paterno,
                    apellido_materno: apellido_materno,
                    direccion: direccion,
                    id: idUsuario
                }),
                success: function(respuesta){
                    console.log('Usuario Modificado');
                    actualizarTabla();
                    limpiarFormulario();
                }
            })
    
          //fin
          });
    
          function actualizarTabla(){
            $('#tablaUsuarios tbody').empty();
    
            $.ajax({
              url: API_URL+'/usuarios',
              type: 'GET',
              dataType: 'json',
              success: function(respuesta){
              console.log(respuesta);
                for (var i = 0; i < respuesta.length; i++){
                    var fila = '<tr>' +
                      '<th scope="row">' + respuesta[i].id + '</th>' +
                      '<td>' + respuesta[i].primer_nombre + '</td>' +
                      '<td>' + respuesta[i].segundo_nombre + '</td>' +
                      '<td>' + respuesta[i].apellido_paterno + '</td>' +
                      '<td>' + respuesta[i].apellido_materno + '</td>' +
                      '<td>' + respuesta[i].direccion + '</td>' +
                      '<td>' +
                        '<div class="btn-group btn-group-sm" role="group" aria-label="Basic example">' +
                          '<button type="button" class="btn btn-success btnEditarusuario"><i class="fa-solid fa-pencil"></i></button>' +
                          '<button type="button" class="btn btn-danger btnEliminarUsuario"><i class="fa-solid fa-trash"></i></button>' +
                        '</div>'
                      '</td>' +
                    '</tr>';
    
                    $('#tablaUsuarios').append(fila)
                }
    
    
              }
            })
    
          }
    
    
          $(document).on('click', '#btnCancelarEdicion', function(){
            limpiarFormulario();
          })
    
    
          function limpiarFormulario(){
            $('#inputPrimerNombre').val('');
            $('#inputSegundoNombre').val('');
            $('#inputApellidoPaterno').val('');
            $('#inputApellidoMaterno').val('');
            $('#inputDireccion').val('');
            $('#inputIdUsuario').val('');
    
            $('#btnAgregarUsuario').show();
            $('#btnEditarUsuarioTabla').hide();
            $('#btnCancelarEdicion').hide();
          }
    
        
        </script>

  </body>
</html>